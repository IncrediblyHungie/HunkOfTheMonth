{% extends "base.html" %}

{% block title %}Generating Calendar{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 text-center">
            <div class="card shadow">
                <div class="card-body p-5">
                    <div class="generating-animation mb-4">
                        <i class="fas fa-magic fa-5x text-primary rotating"></i>
                    </div>

                    <h2 class="mb-4">AI is Transforming You into 12 Hunks...</h2>

                    <p class="lead mb-4">
                        We're putting your face on ridiculously sexy bodies! This takes 5-10 minutes.
                        Feel free to close this page and return later!
                    </p>

                    <div class="progress mb-4" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar"
                             id="progressBar"
                             style="width: 0%">
                            <span id="progressText">0/12 months</span>
                        </div>
                    </div>

                    <!-- Generation Status -->
                    <div class="generation-status">
                        <h5 class="mb-3">Generation Progress:</h5>
                        <div class="row g-2">
                            {% for month in months %}
                            <div class="col-3">
                                <div class="month-status-badge
                                    {% if month.generation_status == 'completed' %}bg-success
                                    {% elif month.generation_status == 'processing' %}bg-warning
                                    {% elif month.generation_status == 'failed' %}bg-danger
                                    {% else %}bg-secondary{% endif %}"
                                    data-month="{{ month.month_number }}">
                                    {{ month.month_number }}
                                    {% if month.generation_status == 'completed' %}
                                        <i class="fas fa-check"></i>
                                    {% elif month.generation_status == 'processing' %}
                                        <i class="fas fa-spinner fa-spin"></i>
                                    {% elif month.generation_status == 'failed' %}
                                        <i class="fas fa-times"></i>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mt-5">
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Check Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Progressive AI generation - one month at a time
const months = {{ months | tojson }};
let currentMonth = 1;
let completedCount = months.filter(m => m.generation_status === 'completed').length;
let failedCount = 0;

const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

function updateProgress() {
    const percentage = (completedCount / 12) * 100;
    progressBar.style.width = percentage + '%';
    progressText.textContent = `${completedCount}/12 months`;
}

async function generateNextMonth() {
    if (currentMonth > 12) {
        // All months processed, redirect to preview
        console.log('All months complete! Redirecting to preview...');
        window.location.href = '{{ url_for("projects.preview") }}';
        return;
    }

    // Check if this month is already completed
    const monthData = months.find(m => m.month_number === currentMonth);
    if (monthData && monthData.generation_status === 'completed') {
        console.log(`Month ${currentMonth} already completed, skipping...`);
        currentMonth++;
        setTimeout(generateNextMonth, 100);
        return;
    }

    console.log(`Generating month ${currentMonth}/12...`);

    try {
        const response = await fetch(`/api/generate/month/${currentMonth}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const data = await response.json();

        if (data.success && data.status === 'completed') {
            console.log(`✅ Month ${currentMonth} completed!`);
            completedCount++;
            updateProgress();

            // Update the month badge
            const badge = document.querySelector(`[data-month="${currentMonth}"]`);
            if (badge) {
                badge.classList.remove('bg-secondary', 'bg-warning');
                badge.classList.add('bg-success');
                badge.innerHTML = `${currentMonth} <i class="fas fa-check"></i>`;
            }
        } else {
            console.error(`❌ Month ${currentMonth} failed:`, data.error);
            failedCount++;

            // Update the month badge
            const badge = document.querySelector(`[data-month="${currentMonth}"]`);
            if (badge) {
                badge.classList.remove('bg-secondary', 'bg-warning');
                badge.classList.add('bg-danger');
                badge.innerHTML = `${currentMonth} <i class="fas fa-times"></i>`;
            }
        }

        // Move to next month
        currentMonth++;

        // Wait 2 seconds between generations (rate limiting)
        setTimeout(generateNextMonth, 2000);

    } catch (error) {
        console.error(`Error generating month ${currentMonth}:`, error);
        failedCount++;
        currentMonth++;

        // Retry next month after delay
        setTimeout(generateNextMonth, 3000);
    }
}

// Initialize progress
updateProgress();

// Check if we need to start generation
if (completedCount < 12) {
    console.log('Starting progressive AI generation...');
    // Wait 1 second before starting
    setTimeout(generateNextMonth, 1000);
} else {
    // All already complete, redirect
    window.location.href = '{{ url_for("projects.preview") }}';
}
</script>
{% endblock %}
